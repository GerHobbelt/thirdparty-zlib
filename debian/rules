#!/usr/bin/make -f
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
#export DH_VERBOSE = 1


include /usr/share/dpkg/default.mk
export DPKG_EXPORT_BUILDTOOLS := 1
include /usr/share/dpkg/buildtools.mk

export DEB_BUILD_MAINT_OPTIONS := hardening=+all qa=+bug reproducible=+all
export DEB_CFLAGS_MAINT_APPEND := $(if $(filter noopt,$(DEB_BUILD_OPTIONS)),,-O3) -ffat-lto-objects
export DEB_CFLAGS_MAINT_STRIP := -O2

export DPKG_GENSYMBOLS_CHECK_LEVEL := 4

generated_headers := crc32_comb_tbl.h crc32_tbl.h inffixed_tbl.h trees_tbl.h


%:
	dh $@ --buildsystem=cmake

common_configure_options := -DCMAKE_INSTALL_INCLUDEDIR=include/$(DEB_HOST_MULTIARCH) \
                            -DZLIB_ENABLE_TESTS=$(if $(filter nocheck,$(DEB_BUILD_OPTIONS) $(DEB_BUILD_PROFILES)),NO,YES) \
                            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=$(if $(filter noopt,$(DEB_BUILD_OPTIONS)),OFF,ON)

compat_dh_options := --builddir=build-compat -pzlib1-ng -pzlib1-ng-dev
native_dh_options := --builddir=build-native -plibz-ng2 -plibz-ng-dev

override_dh_auto_configure:
	# Once for zlib1 compatibility
	dh_auto_configure $(compat_dh_options) -- -DZLIB_COMPAT=ON $(common_configure_options)
	# Once for the native API
	dh_auto_configure $(native_dh_options) -- -DZLIB_COMPAT=OFF $(common_configure_options)
	# And once more for the build tools
	env CC=$(CC_FOR_BUILD) cmake -S . -B build-tools -DWITH_OPTIM=NO
	set -e; \
	for header in $(generated_headers); do \
		if ! [ -f $$header.shipped ]; then \
			cp -a --reflink=auto $$header $$header.shipped; \
		fi; \
	done

override_dh_auto_build: $(generated_headers)
	dh_auto_build $(compat_dh_options)
	dh_auto_build $(native_dh_options)

override_dh_auto_test:
	dh_auto_test $(compat_dh_options)
	dh_auto_test $(native_dh_options)
	if [ -n "$$(dh_listpackages -pzlib1-ng)" ]; then \
		abidiff --no-added-syms --suppressions test/abi/ignore \
			/lib/$(DEB_HOST_MULTIARCH)/libz.so.1 \
			build-compat/libz.so.1; \
	fi

override_dh_auto_install:
	dh_auto_install $(compat_dh_options)
	dh_auto_install $(native_dh_options)

override_dh_installdocs:
	dh_installdocs -pzlib1-ng-dev --link-doc=zlib1-ng
	dh_installdocs -plibz-ng-dev --link-doc=libz-ng2
	dh_installdocs --remaining-packages

override_dh_gencontrol:
	dh_gencontrol -pzlib1-ng -pzlib1-ng-dev -- \
		-Vzlib:Version=$$(grep '#define ZLIB_VERSION' zlib.h | sed -E 's/#define ZLIB_VERSION "(.*).zlib-ng"/\1/')
	dh_gencontrol --remaining-packages

execute_after_dh_clean:
	set -e; \
	for header in $(generated_headers); do \
		if [ -f $$header.shipped ]; then \
			mv $$header.shipped $$header; \
		fi; \
	done


tools/%:
	$(CC_FOR_BUILD) -I. -Ibuild-tools $^ -o $@
tools/makecrct: tools/makecrct.c
tools/makefixed: tools/makefixed.c inftrees.c
tools/maketrees: tools/maketrees.c trees.c

crc32_comb_tbl.h: tools/makecrct
	$< -c > $@

crc32_tbl.h: tools/makecrct
	$< > $@

inffixed_tbl.h: tools/makefixed
	$< > $@

trees_tbl.h: tools/maketrees
	$< > $@
